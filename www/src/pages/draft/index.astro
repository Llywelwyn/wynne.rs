---
export const prerender = false;

import { getSession } from 'auth-astro/server';
import { getCollection } from 'astro:content';
import { isAdmin } from '../../lib/auth';
import Layout from '../../layouts/Layout.astro';
import { formatDate } from '../../lib/format';
import { organizePostsByCategory, getSlug } from '../../lib/posts';

let session;
try {
  session = await getSession(Astro.request);
} catch {
  return new Response('Auth not configured', { status: 500 });
}

if (!session) {
  return Astro.redirect('/api/auth/signin');
}

if (!isAdmin(session.user?.id)) {
  return new Response('Forbidden', { status: 403 });
}

const posts = await getCollection('md', ({ data }) => data.draft === true);
const { grouped, categories: sortedCategories } = organizePostsByCategory(posts);
---
<Layout title="drafts - lewis m.w.">

<p class="muted">logged in as {session.user?.name} <a href="/api/auth/signout">sign out</a></p>

{sortedCategories.length === 0 ? (
  <p class="muted">no drafts</p>
) : (
  sortedCategories.map(category => (
    <details open>
      <summary>{category}</summary>
      <pre set:html={grouped[category].map(post => `<span class="muted">${formatDate(post.data.date)}</span>    <a href="/draft/${getSlug(post.id)}">${post.data.title}</a>${post.data.pinned ? ' [pinned]' : ''}`).join('\n')} />
    </details>
  ))
)}
</Layout>
