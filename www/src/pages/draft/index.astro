---
export const prerender = false;

import { getCollection } from 'astro:content';
import { requireAdminSession } from '../../lib/auth';
import Layout from '../../layouts/Layout.astro';
import { formatListItem } from '../../lib/format';
import { organizePostsByCategory, getSlug, enrichPostsWithDates } from '../../lib/md';

const { session, error } = await requireAdminSession(Astro.request);
if (error) return error;
if (!session) return Astro.redirect('/api/auth/signin');

const rawPosts = await getCollection('md', ({ data }) => data.draft === true);
const posts = enrichPostsWithDates(rawPosts);
const { grouped, categories: sortedCategories } = organizePostsByCategory(posts);
---
<Layout title="drafts - lewis m.w.">

<p class="muted">logged in as {session.user?.name} <a href="/api/auth/signout">sign out</a></p>

{sortedCategories.length === 0 ? (
  <p class="muted">no drafts</p>
) : (
  sortedCategories.map(category => (
    <details open>
      <summary>{category}</summary>
      <pre set:html={grouped[category].map(post => formatListItem(post.dates.created, `/draft/${getSlug(post.id)}`, post.data.title, { pinned: post.data.pinned })).join('\n')} />
    </details>
  ))
)}
</Layout>
