---
export const prerender = false;

import { getSession } from 'auth-astro/server';
import { getCollection, render } from 'astro:content';
import { isAdmin } from '../../lib/auth';
import Layout from '../../layouts/Layout.astro';
import { formatDate } from '../../lib/format';
import { getSlug } from '../../utils';

let session;
try {
  session = await getSession(Astro.request);
} catch {
  return new Response('Auth not configured', { status: 500 });
}

if (!session) {
  return Astro.redirect('/api/auth/signin');
}

if (!isAdmin(session.user?.id)) {
  return new Response('Forbidden', { status: 403 });
}

const slug = Astro.params.slug;
const posts = await getCollection('md', ({ data }) => data.draft === true);
const post = posts.find(p => getSlug(p.id) === slug);

if (!post) {
  return new Response('Not found', { status: 404 });
}

const { Content } = await render(post);
---
<Layout title={`${post.data.title} - lewis m.w.`}>

<article>
<h1>{post.data.title}</h1>
<p class="muted" style="margin-top: 0;">{formatDate(post.data.date)}</p>
<Content />
</article>
</Layout>
