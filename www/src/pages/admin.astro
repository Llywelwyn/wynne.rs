---
export const prerender = false;

import { getPendingEntries, type GuestbookEntry } from '../lib/db';
import { requireAdminSession } from '../lib/auth';
import Layout from '../layouts/Layout.astro';
import { formatDate } from '../lib/format';

const { session, error } = await requireAdminSession(Astro.request);
if (error) return error;
if (!session) return Astro.redirect('/api/auth/signin');

let entries: GuestbookEntry[] = [];
try {
  entries = await getPendingEntries();
} catch {
  // handle error
}
---
<Layout title="admin - guestbook" showHeader={false}>

<h1>guestbook admin</h1>
<p>logged in as {session.user?.name} <a href="/api/auth/signout">sign out</a></p>

<p><button id="deploy">redeploy site</button> <span id="deploy-status"></span></p>

{entries.length === 0 ? (
  <p class="muted">no pending entries</p>
) : (
  <ul id="entries">
    {entries.map(e => (
      <li data-id={e.id}>
        <span class="muted">{formatDate(e.createdAt)}</span>
        <strong>{e.name}</strong>
        {e.url && <a href={e.url}>{e.url}</a>}
        <p>{e.message}</p>
        <button class="approve">approve</button>
        <button class="reject">reject</button>
      </li>
    ))}
  </ul>
)}

<script>
  document.getElementById('deploy')?.addEventListener('click', async (e) => {
    const btn = e.target as HTMLButtonElement;
    const status = document.getElementById('deploy-status');
    btn.disabled = true;
    if (status) status.textContent = 'deploying...';

    const res = await fetch('/api/deploy', { method: 'POST' });
    if (res.ok) {
      if (status) status.textContent = 'deploy triggered!';
    } else {
      const data = await res.json();
      if (status) status.textContent = data.error || 'deploy failed';
    }
    btn.disabled = false;
  });

  document.querySelectorAll('#entries li').forEach(li => {
    const id = li.getAttribute('data-id');

    li.querySelector('.approve')?.addEventListener('click', async () => {
      const res = await fetch(`/api/guestbook/${id}`, { method: 'PATCH' });
      if (res.ok) li.remove();
    });

    li.querySelector('.reject')?.addEventListener('click', async () => {
      const res = await fetch(`/api/guestbook/${id}`, { method: 'DELETE' });
      if (res.ok) li.remove();
    });
  });
</script>
</Layout>
