---
import { getCollection } from 'astro:content';
import '../styles/global.css';
import yaml from 'js-yaml';
import bookmarksRaw from '../data/bookmarks.yaml?raw';
import fs from 'node:fs';
import path from 'node:path';

interface Bookmark {
  date: string;
  title: string;
  url: string;
}

interface TxtFile {
  name: string;
  mtime: Date;
}

const posts = await getCollection('posts');
const sorted = posts.sort((a, b) => b.data.date.getTime() - a.data.date.getTime());

const bookmarks = (yaml.load(bookmarksRaw) as Bookmark[])
  .sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime());

// Auto-discover txt files from public/txt/
const txtDir = path.join(process.cwd(), 'public/txt');
const txtFiles: TxtFile[] = fs.existsSync(txtDir)
  ? fs.readdirSync(txtDir)
      .filter(file => file.endsWith('.txt'))
      .map(name => {
        const stat = fs.statSync(path.join(txtDir, name));
        return { name, mtime: stat.mtime };
      })
      .sort((a, b) => b.mtime.getTime() - a.mtime.getTime())
  : [];

function formatDate(date: Date): string {
  const d = String(date.getDate()).padStart(2, '0');
  const m = String(date.getMonth() + 1).padStart(2, '0');
  const y = String(date.getFullYear()).slice(-2);
  return `${d}/${m}/${y}`;
}

function formatBookmarkDate(dateStr: string): string {
  const date = new Date(dateStr);
  return formatDate(date);
}

function extractDomain(url: string): string {
  try {
    const parsed = new URL(url);
    return parsed.hostname.replace(/^www\./, '');
  } catch {
    return url;
  }
}
---
<!DOCTYPE html>
<html>
<head><meta charset="UTF-8"><title>lewis m.w.</title></head>
<body>
<pre set:html={[
  'lewis m.w.  <a href="mailto:lewis@wynne.rs">mail</a> <a href="https://github.com/llywelwyn">gh</a>',
  '',
  'blog',
  ...sorted.map(post => `<span class="muted">${formatDate(post.data.date)}</span>    <a href="/${post.id}">${post.data.title}</a>`),
  '',
  'txt',
  ...txtFiles.map(f => `<span class="muted">${formatDate(f.mtime)}</span>    <a href="/txt/${f.name}">${f.name}</a>`),
  '',
  'bookmarks',
  ...bookmarks.map(b => `<span class="muted">${formatBookmarkDate(b.date)}</span>    <a href="${b.url}">${b.title}</a> <span class="muted">(${extractDomain(b.url)})</span>`)
].join('\n')} />
</body>
</html>
