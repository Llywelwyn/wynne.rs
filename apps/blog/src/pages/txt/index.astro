---
import Layout from '../../layouts/Layout.astro';
import fs from 'node:fs';
import path from 'node:path';
import yaml from 'js-yaml';

interface TxtFile {
  name: string;
  mtime: Date;
  pinned: boolean;
}

interface TxtConfig {
  pinned?: string[];
}

const txtDir = path.join(process.cwd(), 'public/txt');
const configPath = path.join(txtDir, 'config.yaml');
const config: TxtConfig = fs.existsSync(configPath)
  ? yaml.load(fs.readFileSync(configPath, 'utf8')) as TxtConfig
  : {};
const pinnedSet = new Set(config.pinned || []);

const txtFiles: TxtFile[] = fs.existsSync(txtDir)
  ? fs.readdirSync(txtDir)
      .filter(file => file.endsWith('.txt'))
      .map(name => {
        const stat = fs.statSync(path.join(txtDir, name));
        return { name, mtime: stat.mtime, pinned: pinnedSet.has(name) };
      })
      .sort((a, b) => {
        if (a.pinned && !b.pinned) return -1;
        if (!a.pinned && b.pinned) return 1;
        return b.mtime.getTime() - a.mtime.getTime();
      })
  : [];

function formatDate(date: Date): string {
  const d = String(date.getDate()).padStart(2, '0');
  const m = String(date.getMonth() + 1).padStart(2, '0');
  const y = String(date.getFullYear()).slice(-2);
  return `${d}/${m}/${y}`;
}
---
<Layout title="txt - lewis m.w.">

<details open>
  <summary>txt</summary>
<pre set:html={txtFiles.map(f => `<span class="muted">${formatDate(f.mtime)}</span>    <a href="/txt/${f.name}">${f.name}</a>${f.pinned ? ' [pinned]' : ''}`).join('\n')} />
</details>
</Layout>
